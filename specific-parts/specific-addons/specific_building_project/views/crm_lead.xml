<?xml version="1.0" encoding="UTF-8"?>
<odoo>

  <record model="ir.ui.view" id="crm_case_form_view_oppor">
    <field name="name">Opportunities</field>
    <field name="model">crm.lead</field>
    <field name="inherit_id" ref="crm.crm_case_form_view_oppor"/>
    <field name="arch" type="xml">
      <xpath expr="//button[@name='%(sale_crm.sale_action_quotations_new)d']" position="attributes">
        <attribute name="context">
          {'search_default_partner_id': partner_id,
           'default_partner_id': partner_id,
           'default_team_id': team_id,
           'default_building_project_id': project_id}
         </attribute>
         <attribute name="attrs">{'invisible': ['|', ('probability', '=', 0), ('building_project_id', '!=', False)]}</attribute>
      </xpath>
      <xpath expr="//button[@name='%(sale_crm.sale_action_quotations_new)d']/following-sibling::button[1]" position="attributes">
        <attribute name="context">
          {'search_default_partner_id': partner_id,
           'default_partner_id': partner_id,
           'default_team_id': team_id,
           'default_project_id': project_id}
         </attribute>
         <attribute name="attrs">{'invisible': ['|', ('probability', '>', 0), ('building_project_id', '!=', False)]}</attribute>
      </xpath>
      <xpath expr="//button[@name='%(sale_crm.sale_action_quotations_new)d']" position="after">
        <button attrs="{'invisible': ['|', ('probability', '=', 0), ('building_project_id', '=', False)]}" string="New Quotation" name="quotation_new_wholesaler" type="object" class="oe_highlight"
            context="{'search_default_partner_id': partner_id,
                      'default_partner_id': partner_id,
                      'default_team_id': team_id}"/>
        <button attrs="{'invisible': ['|', ('probability', '>', 0), ('building_project_id', '=', False)]}" string="New Quotation" name="quotation_new_wholesaler" type="object"
            context="{'search_default_partner_id': partner_id,
                      'default_partner_id': partner_id,
                      'default_team_id': team_id}"/>
      </xpath>

      <button name="action_schedule_meeting" position="after">
        <button class="oe_stat_button" type="object"
          name="action_schedule_phonecall" icon="fa-phone">
          <div class="o_stat_info">
            <field name="phonecall_count" class="o_stat_value"/>
            <span class="o_stat_text" attrs="{'invisible': [('phonecall_count', '&lt;', 2)]}"> Phonecalls</span>
            <span class="o_stat_text" attrs="{'invisible': [('phonecall_count', '&gt;', 1)]}"> Phonecall</span>
          </div>
        </button>
      </button>

      <field name="partner_id" position="before">
        <field name="building_project_id"/>
        <field name="project_id" invisible="True"/>
      </field>
    </field>
  </record>

  <!-- Opportunities Search View -->
  <record id="view_crm_case_opportunities_filter" model="ir.ui.view">
    <field name="name">CRM - Opportunities Search</field>
    <field name="model">crm.lead</field>
    <field name="inherit_id" ref="crm.view_crm_case_opportunities_filter"/>
    <field name="arch" type="xml">
      <field name="name" position="attributes">
        <attribute name="filter_domain">['|','|','|','|',('building_project_id','ilike',self),('partner_id','ilike',self),('partner_name','ilike',self),('email_from','ilike',self),('name', 'ilike', self)]</attribute>
      </field>
      <field name="partner_id" position="before">
        <field name="building_project_id"/>
      </field>
    </field>
  </record>

</odoo>
